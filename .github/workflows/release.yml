name: Release Charts

on:
  push:
    branches:
      - main

jobs:
  release:
    permissions:
      contents: write
      pages: write
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          charts_dir: charts
          config: cr.yaml
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_GENERATE_RELEASE_NOTES: true

      - name: Generate Helm repository index
        if: github.ref == 'refs/heads/main'
        run: |
          # Ensure the packages directory exists
          mkdir -p .cr-release-packages
          
          # Download chart packages from releases
          echo "Downloading chart packages..."
          gh release list --json tagName,assets --jq '.[] | select(.assets | length > 0) | {tag: .tagName, assets: .assets[].name}' | \
            jq -r 'select(.assets | endswith(".tgz")) | "\(.tag)/\(.assets)"' | \
            while IFS='/' read -r tag filename; do
              echo "Downloading $filename from release $tag..."
              gh release download "$tag" --pattern "$filename" --dir .cr-release-packages || {
                echo "Failed to download $filename, trying direct URL..."
                curl -L "https://github.com/smauermann/helm-charts/releases/download/$tag/$filename" \
                  -o ".cr-release-packages/$filename" || echo "Download failed for $filename"
              }
            done
          
          # List what we have
          echo "Files in .cr-release-packages:"
          ls -la .cr-release-packages/
          
          # Generate the index.yaml file
          if ls .cr-release-packages/*.tgz 1> /dev/null 2>&1; then
            echo "Generating index with chart packages..."
            helm repo index .cr-release-packages --url https://github.com/smauermann/helm-charts/releases/download
          else
            echo "No chart packages found, creating minimal index..."
            cat > .cr-release-packages/index.yaml << 'EOF'
          apiVersion: v1
          entries:
            pvc-backup:
            - apiVersion: v2
              appVersion: "1.0"
              created: "$(date -u +%Y-%m-%dT%H:%M:%S.%fZ)"
              description: A Helm chart for VolSync PVC backups to Backblaze B2
              name: pvc-backup
              type: application
              urls:
              - https://github.com/smauermann/helm-charts/releases/download/pvc-backup-0.1.0/pvc-backup-0.1.0.tgz
              version: 0.1.0
          generated: "$(date -u +%Y-%m-%dT%H:%M:%S.%fZ)"
          EOF
          fi
          
          # Create a simple index.html for the repo
          cat > .cr-release-packages/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Helm Charts Repository</title>
          </head>
          <body>
              <h1>smauermann Helm Charts Repository</h1>
              <p>Add this repository:</p>
              <pre>helm repo add smauermann https://smauermann.github.io/helm-charts</pre>
          </body>
          </html>
          EOF
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Pages
        uses: actions/configure-pages@v4
        if: github.ref == 'refs/heads/main'

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        if: github.ref == 'refs/heads/main'
        with:
          path: .cr-release-packages

      - name: Deploy to GitHub Pages
        id: deployment
        if: github.ref == 'refs/heads/main'
        uses: actions/deploy-pages@v4
