# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/volsync.backube/replicationsource_v1alpha1.json
---
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: {{ .Values.appName }}-data-b2
  labels:
    {{- include "chart.labels" . | nindent 4 }}
spec:
  sourcePVC: {{ .Values.pvcName }}
  {{- $trigger := .Values.backup.trigger }}
  {{- $hasSchedule := and $trigger.schedule (ne $trigger.schedule "") }}
  {{- $hasManual := and $trigger.manual (ne $trigger.manual "") }}
  {{- if and (not $hasManual) (not $hasSchedule) }}
    {{- fail "backup.trigger: configure schedule or manual value" }}
  {{- end }}
  trigger:
    {{- if $hasManual }}
    manual: {{ $trigger.manual | quote }}
    {{- else if $hasSchedule }}
    schedule: {{ $trigger.schedule | quote }}
    {{- end }}
  restic:
    cacheCapacity: {{ .Values.backup.cacheCapacity }}
    cacheStorageClassName: {{ .Values.backup.cacheStorageClassName }}
    copyMethod: Snapshot
    moverSecurityContext:
      runAsUser: {{ .Values.restic.runAsUser }}
      runAsGroup: {{ .Values.restic.runAsGroup }}
      fsGroup: {{ .Values.restic.fsGroup }}
      fsGroupChangePolicy: Always
    pruneIntervalDays: {{ .Values.backup.pruneIntervalDays }}
    retain:
      hourly: {{ .Values.backup.retain.hourly }}
      daily: {{ .Values.backup.retain.daily }}
      weekly: {{ .Values.backup.retain.weekly }}
    repository: {{ .Values.appName }}-volsync-b2
    storageClassName: {{ .Values.backup.storageClassName }}
    volumeSnapshotClassName: {{ .Values.backup.volumeSnapshotClassName }}
