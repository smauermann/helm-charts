name: Release Charts

on:
  push:
    branches:
      - main

jobs:
  release:
    permissions:
      contents: write
      pages: write
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          charts_dir: charts
          config: cr.yaml
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_GENERATE_RELEASE_NOTES: true

      - name: Generate Helm repository index
        if: github.ref == 'refs/heads/main'
        run: |
          # Ensure the packages directory exists
          mkdir -p .cr-release-packages
          
          # Generate the index.yaml file
          helm repo index .cr-release-packages --url https://github.com/smauermann/helm-charts/releases/download
          
          # Create a simple index.html for the repo
          cat > .cr-release-packages/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Helm Charts Repository</title>
          </head>
          <body>
              <h1>smauermann Helm Charts Repository</h1>
              <p>Add this repository:</p>
              <pre>helm repo add smauermann https://smauermann.github.io/helm-charts</pre>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4
        if: github.ref == 'refs/heads/main'

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        if: github.ref == 'refs/heads/main'
        with:
          path: .cr-release-packages

      - name: Deploy to GitHub Pages
        id: deployment
        if: github.ref == 'refs/heads/main'
        uses: actions/deploy-pages@v4
