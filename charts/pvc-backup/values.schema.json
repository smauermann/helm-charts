{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": [
    "appName"
  ],
  "properties": {
    "appName": {
      "type": "string",
      "description": "Application name used in resource naming (e.g., 'jellyfin', 'radarr')",
      "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$",
      "minLength": 1,
      "maxLength": 63
    },
    "argoSyncWave": {
      "description": "ArgoCD sync wave annotation applied to generated resources",
      "type": "string",
      "default": "-100"
    },
    "backup": {
      "type": "object",
      "description": "Backup configuration settings",
      "required": [
        "pvcName"
      ],
      "properties": {
        "trigger": {
          "type": "object",
          "description": "Backup trigger configuration. Provide a cron schedule, a manual trigger, or both (manual overrides schedule when both are set).",
          "properties": {
            "schedule": {
              "type": [
                "string",
                "null"
              ],
              "description": "Cron schedule for backups (default: daily at 1 AM)",
              "pattern": "^(@(annually|yearly|monthly|weekly|daily|hourly|reboot))|(@every (\\d+(ns|us|\u00b5s|ms|s|m|h))+)|((((\\d+,)+\\d+|(\\d+([/\\-])\\d+)|\\d+|\\*) ?){5,7})$",
              "default": "0 1 * * *"
            },
            "manual": {
              "type": [
                "string",
                "null"
              ],
              "description": "Manual trigger name for backup operation. Change this value to initiate a backup immediately. When set, schedule is ignored.",
              "minLength": 1,
              "maxLength": 63,
              "default": null
            }
          },
          "additionalProperties": false,
          "default": {
            "schedule": "0 1 * * *",
            "manual": null
          },
          "anyOf": [
            {
              "required": [
                "schedule"
              ],
              "properties": {
                "schedule": {
                  "type": "string",
                  "minLength": 1
                }
              }
            },
            {
              "required": [
                "manual"
              ],
              "properties": {
                "manual": {
                  "type": "string",
                  "minLength": 1
                }
              }
            }
          ]
        },
        "retain": {
          "type": "object",
          "description": "Backup retention policy",
          "properties": {
            "hourly": {
              "type": "integer",
              "description": "Number of hourly backups to retain",
              "minimum": 0,
              "maximum": 168,
              "default": 0
            },
            "daily": {
              "type": "integer",
              "description": "Number of daily backups to retain",
              "minimum": 1,
              "maximum": 365,
              "default": 7
            },
            "weekly": {
              "type": "integer",
              "description": "Number of weekly backups to retain",
              "minimum": 0,
              "maximum": 52,
              "default": 4
            }
          },
          "additionalProperties": false
        },
        "pruneIntervalDays": {
          "type": "integer",
          "description": "Interval in days between backup pruning operations",
          "minimum": 1,
          "maximum": 365,
          "default": 7
        },
        "cacheCapacity": {
          "type": "string",
          "description": "Size of the restic cache volume (e.g., '2Gi', '1Gi')",
          "pattern": "^\\d+([EPTGMK]i?)?$",
          "default": "2Gi"
        },
        "cacheStorageClass": {
          "type": "string",
          "description": "Storage class for restic cache volumes",
          "minLength": 1,
          "default": "longhorn-single-replica"
        },
        "pvcName": {
          "type": "string",
          "description": "Name of the source PersistentVolumeClaim to backup",
          "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$",
          "minLength": 1,
          "maxLength": 63
        },
        "storageClass": {
          "type": "string",
          "description": "Storage class used for replication source volumes",
          "minLength": 1,
          "default": "longhorn"
        },
        "volumeSnapshotClass": {
          "type": "string",
          "description": "VolumeSnapshotClass used when creating PVC snapshots",
          "minLength": 1,
          "default": "longhorn-snapshot"
        }
      },
      "required": ["pvcName"],
      "additionalProperties": false
    },
    "restore": {
      "type": "object",
      "description": "Restore configuration for recovering PVC data from backups",
      "required": [
        "pvcSize"
      ],
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable restore functionality (creates ReplicationDestination)",
          "default": false
        },
        "trigger": {
          "type": "string",
          "description": "Manual trigger name for restore operation",
          "minLength": 1,
          "maxLength": 63,
          "default": "restore"
        },
        "restoreAsOf": {
          "type": "string",
          "description": "RFC-3339 timestamp for point-in-time restore (optional)",
          "pattern": "^(|\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{3})?Z?)$"
        },
        "enableFileDeletion": {
          "type": "boolean",
          "description": "Enable file deletion during restore - files on PVC will be deleted if they don't exist in snapshot",
          "default": false
        },
        "cleanupCachePVC": {
          "type": "boolean",
          "description": "Enable cache PVC deletion after restore",
          "default": false
        },
        "cleanupTempPVC": {
          "type": "boolean",
          "description": "Enable temporary destination PVC deletion. Ignored when restore.pvcName is set",
          "default": false
        },
        "pvcName": {
          "type": "string",
          "description": "Name of the destination PVC (defaults to backup.pvcName when empty)",
          "pattern": "^(|[a-z0-9]([-a-z0-9]*[a-z0-9])?)$",
          "maxLength": 63,
          "default": ""
        },
        "pvcSize": {
          "type": "string",
          "description": "Size of the destination PVC created for restore operations",
          "pattern": "^(|\\d+([EPTGMK]i?)?)$",
          "default": ""
        },
        "storageClass": {
          "type": "string",
          "description": "Storage class for restore destination PVCs (defaults to backup.storageClass)",
          "default": ""
        },
        "accessModes": {
          "type": "array",
          "description": "Access modes applied to the restore PVC",
          "items": {
            "type": "string",
            "enum": [
              "ReadWriteOnce",
              "ReadWriteMany",
              "ReadOnlyMany"
            ]
          },
          "minItems": 1,
          "uniqueItems": true,
          "default": [
            "ReadWriteOnce"
          ]
        },
        "cacheCapacity": {
          "type": "string",
          "description": "Restic cache volume size override for restore operations (defaults to backup.cacheCapacity)",
          "pattern": "^(|\\d+([EPTGMK]i?)?)$",
          "default": ""
        },
        "cacheStorageClass": {
          "type": "string",
          "description": "Restic cache storage class override for restore operations (defaults to backup.cacheStorageClass)",
          "default": ""
        }
      },
      "additionalProperties": false
    },
    "restic": {
      "type": "object",
      "description": "Restic security context configuration",
      "properties": {
        "runAsUser": {
          "type": "integer",
          "description": "User ID to run restic process",
          "minimum": 0,
          "maximum": 65535,
          "default": 65534
        },
        "runAsGroup": {
          "type": "integer",
          "description": "Group ID to run restic process",
          "minimum": 0,
          "maximum": 65535,
          "default": 65534
        },
        "fsGroup": {
          "type": "integer",
          "description": "File system group ID for restic volumes",
          "minimum": 0,
          "maximum": 65535,
          "default": 65534
        }
      },
      "additionalProperties": false
    },
    "s3": {
      "type": "object",
      "description": "S3-compatible repository configuration via External Secrets",
      "properties": {
        "provider": {
          "type": "string",
          "description": "Provider identifier used in repository naming",
          "minLength": 1,
          "pattern": "^[a-z0-9\\-]+$",
          "default": "b2"
        },
        "secretStoreRef": {
          "type": "object",
          "description": "Reference to the secret store containing repository credentials",
          "properties": {
            "kind": {
              "type": "string",
              "description": "Type of secret store",
              "enum": [
                "SecretStore",
                "ClusterSecretStore"
              ],
              "default": "ClusterSecretStore"
            },
            "name": {
              "type": "string",
              "description": "Name of the secret store",
              "minLength": 1,
              "default": "onepassword-connect"
            }
          },
          "additionalProperties": false
        },
        "secretKey": {
          "type": "string",
          "description": "Key name in the secret store containing repository credentials",
          "minLength": 1,
          "default": "backblaze-volsync"
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
