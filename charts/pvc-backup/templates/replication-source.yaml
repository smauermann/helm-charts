# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/volsync.backube/replicationsource_v1alpha1.json
{{- if .Values.backup.enabled }}
apiVersion: volsync.backube/v1alpha1
kind: ReplicationSource
metadata:
  name: {{ include "chart.repository" . }}
  labels:
    {{- include "chart.labels" . | nindent 4 }}
spec:
  sourcePVC: {{ .Values.backup.pvcName }}
  trigger:
    {{- with .Values.backup.trigger.manual }}
    manual: {{ . | quote }}
    {{- end }}
    {{- with .Values.backup.trigger.schedule }}
    schedule: {{ . | quote }}
    {{- end }}
  restic:
    cacheCapacity: {{ .Values.backup.cacheCapacity }}
    cacheStorageClassName: {{ .Values.backup.cacheStorageClass }}
    copyMethod: Snapshot
    moverSecurityContext:
      runAsUser: {{ .Values.restic.runAsUser }}
      runAsGroup: {{ .Values.restic.runAsGroup }}
      fsGroup: {{ .Values.restic.fsGroup }}
      fsGroupChangePolicy: Always
    pruneIntervalDays: {{ .Values.backup.pruneIntervalDays }}
    retain:
      hourly: {{ .Values.backup.retain.hourly }}
      daily: {{ .Values.backup.retain.daily }}
      weekly: {{ .Values.backup.retain.weekly }}
    repository: {{ include "chart.repository" . }}
    storageClassName: {{ .Values.backup.storageClass }}
    volumeSnapshotClassName: {{ .Values.backup.volumeSnapshotClass }}
{{- end }}
