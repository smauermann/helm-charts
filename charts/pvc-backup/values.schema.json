{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["appName", "pvcName"],
  "properties": {
    "appName": {
      "type": "string",
      "description": "Application name used in resource naming (e.g., 'jellyfin', 'radarr')",
      "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$",
      "minLength": 1,
      "maxLength": 63
    },
    "pvcName": {
      "type": "string",
      "description": "Name of the PersistentVolumeClaim to backup",
      "pattern": "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$",
      "minLength": 1,
      "maxLength": 63
    },
    "backup": {
      "type": "object",
      "description": "Backup configuration settings",
      "required": ["trigger"],
      "properties": {
        "trigger": {
          "type": "object",
          "description": "Backup trigger configuration. Provide a cron schedule, a manual trigger, or both (manual overrides schedule when both are set).",
          "properties": {
            "schedule": {
              "type": ["string", "null"],
              "description": "Cron schedule for backups (default: daily at 1 AM)",
              "pattern": "^(@(annually|yearly|monthly|weekly|daily|hourly|reboot))|(@every (\\d+(ns|us|Âµs|ms|s|m|h))+)|((((\\d+,)+\\d+|(\\d+([/\\-])\\d+)|\\d+|\\*) ?){5,7})$",
              "default": "0 1 * * *"
            },
            "manual": {
              "type": ["string", "null"],
              "description": "Manual trigger name for backup operation. Change this value to initiate a backup immediately. When set, schedule is ignored.",
              "minLength": 1,
              "maxLength": 63,
              "default": null
            }
          },
          "additionalProperties": false,
          "default": {
            "schedule": "0 1 * * *",
            "manual": null
          },
          "anyOf": [
            {
              "required": ["schedule"],
              "properties": {
                "schedule": {
                  "type": "string",
                  "minLength": 1
                }
              }
            },
            {
              "required": ["manual"],
              "properties": {
                "manual": {
                  "type": "string",
                  "minLength": 1
                }
              }
            }
          ]
        },
        "retain": {
          "type": "object",
          "description": "Backup retention policy",
          "properties": {
            "hourly": {
              "type": "integer",
              "description": "Number of hourly backups to retain",
              "minimum": 0,
              "maximum": 168,
              "default": 0
            },
            "daily": {
              "type": "integer",
              "description": "Number of daily backups to retain",
              "minimum": 1,
              "maximum": 365,
              "default": 7
            },
            "weekly": {
              "type": "integer",
              "description": "Number of weekly backups to retain",
              "minimum": 0,
              "maximum": 52,
              "default": 4
            }
          },
          "additionalProperties": false
        },
        "pruneIntervalDays": {
          "type": "integer",
          "description": "Interval in days between backup pruning operations",
          "minimum": 1,
          "maximum": 365,
          "default": 7
        },
        "cacheCapacity": {
          "type": "string",
          "description": "Size of the restic cache volume (e.g., '2Gi', '1Gi')",
          "pattern": "^\\d+([EPTGMK]i?)?$",
          "default": "2Gi"
        },
        "cacheStorageClassName": {
          "type": "string",
          "description": "Storage class for restic cache volumes",
          "default": "longhorn-single-replica"
        },
        "storageClassName": {
          "type": "string",
          "description": "Storage class for destination volumes",
          "default": "longhorn"
        },
        "volumeSnapshotClassName": {
          "type": "string",
          "description": "Volume snapshot class for creating PVC snapshots",
          "default": "longhorn-snapshot"
        }
      },
      "additionalProperties": false
    },
    "restic": {
      "type": "object",
      "description": "Restic security context configuration",
      "properties": {
        "runAsUser": {
          "type": "integer",
          "description": "User ID to run restic process",
          "minimum": 0,
          "maximum": 65535,
          "default": 65534
        },
        "runAsGroup": {
          "type": "integer",
          "description": "Group ID to run restic process",
          "minimum": 0,
          "maximum": 65535,
          "default": 65534
        },
        "fsGroup": {
          "type": "integer",
          "description": "File system group ID for restic volumes",
          "minimum": 0,
          "maximum": 65535,
          "default": 65534
        }
      },
      "additionalProperties": false
    },
    "b2": {
      "type": "object",
      "description": "Backblaze B2 configuration via External Secrets",
      "properties": {
        "secretStoreRef": {
          "type": "object",
          "description": "Reference to the secret store containing B2 credentials",
          "properties": {
            "kind": {
              "type": "string",
              "description": "Type of secret store",
              "enum": ["SecretStore", "ClusterSecretStore"],
              "default": "ClusterSecretStore"
            },
            "name": {
              "type": "string",
              "description": "Name of the secret store",
              "default": "onepassword-connect"
            }
          },
          "required": ["kind", "name"],
          "additionalProperties": false
        },
        "secretKey": {
          "type": "string",
          "description": "Key name in the secret store containing B2 credentials",
          "default": "backblaze-volsync"
        }
      },
      "additionalProperties": false
    },
    "restore": {
      "type": "object",
      "description": "Restore configuration for recovering PVC data from backups",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable restore functionality (creates ReplicationDestination)",
          "default": false
        },
        "destinationPVC": {
          "type": "string",
          "description": "Name of the PVC to restore data into (defaults to pvcName if empty)",
          "pattern": "^(|[a-z0-9]([-a-z0-9]*[a-z0-9])?)$",
          "maxLength": 63
        },
        "trigger": {
          "type": "string",
          "description": "Manual trigger name for restore operation",
          "minLength": 1,
          "maxLength": 63,
          "default": "restore"
        },
        "restoreAsOf": {
          "type": "string",
          "description": "RFC-3339 timestamp for point-in-time restore (optional)",
          "pattern": "^(|\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{3})?Z?)$"
        },
        "copyMethod": {
          "type": "string",
          "description": "Copy method for restore operation",
          "enum": ["Direct", "Clone", "Snapshot"],
          "default": "Snapshot"
        },
        "cacheCapacity": {
          "type": "string",
          "description": "Size of restic cache volume for restore (defaults to backup.cacheCapacity)",
          "pattern": "^(|\\d+([EPTGMK]i?)?)$"
        },
        "cacheStorageClassName": {
          "type": "string",
          "description": "Storage class for restore cache volumes (defaults to backup.cacheStorageClassName)",
          "default": ""
        },
        "storageClassName": {
          "type": "string",
          "description": "Storage class for destination volumes used during restore (defaults to backup.storageClassName)"
        },
        "enableFileDeletion": {
          "type": "boolean",
          "description": "Enable file deletion during restore - files on PVC will be deleted if they don't exist in snapshot",
          "default": false
        },
        "cleanupCachePVC": {
          "type": "boolean",
          "description": "Enable cache PVC deletion after restore",
          "default": false
        },
        "cleanupTempPVC": {
          "type": "boolean",
          "description": "Enable temporary destination PVC deletion. Ignored if `destinationPVC` is set",
          "default": false
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
